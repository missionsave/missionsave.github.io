<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Simple EPUB Reader</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Dependencies -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://unpkg.com/epubjs/dist/epub.min.js"></script>
  <style>
    :root {
      --bg: #ffffff;
      --fg: #111111;
      --muted: #6b7280;
      --accent: #2563eb;
      --panel: #f3f4f6;
      --border: #e5e7eb;
    }
    .dark {
      --bg: #0b0f14;
      --fg: #e5e7eb;
      --muted: #9aa4b2;
      --accent: #60a5fa;
      --panel: #111827;
      --border: #1f2937;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--fg);
      font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      height: 100vh;
      display: grid;
      grid-template-rows: auto 1fr auto;
    }
    header, footer {
      background: var(--panel);
      border-bottom: 1px solid var(--border);
      padding: 8px 12px;
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }
    footer { border-top: 1px solid var(--border); border-bottom: none; }
    .toolbar-group { display: flex; gap: 8px; align-items: center; }
    label { color: var(--muted); font-weight: 600; }
    input[type="text"] {
      padding: 6px 8px;
      border: 1px solid var(--border);
      background: var(--bg);
      color: var(--fg);
      border-radius: 6px;
      min-width: 260px;
    }
    input[type="file"] { color: var(--muted); }
    button {
      border: 1px solid var(--border);
      background: var(--bg);
      color: var(--fg);
      border-radius: 6px;
      padding: 6px 10px;
      cursor: pointer;
    }
    button:hover { border-color: var(--accent); }
    #app {
      display: grid;
      grid-template-columns: 280px 1fr;
      min-height: 0;
    }
    #toc {
      border-right: 1px solid var(--border);
      background: var(--panel);
      padding: 8px;
      overflow: auto;
    }
    #toc h3 {
      margin: 8px 8px 4px;
      font-size: 12px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .06em;
    }
    #toc ul { list-style: none; padding: 0; margin: 0; }
    #toc li {
      margin: 2px 0;
      border-radius: 6px;
    }
    #toc a {
      display: block;
      padding: 6px 8px;
      text-decoration: none;
      color: var(--fg);
      border-radius: 6px;
    }
    #toc a:hover { background: rgba(37,99,235,0.12); }
    #viewer {
      height: calc(100vh - 106px);
      /* header ~56px + footer ~50px; adjust if you tweak spacing */
      overflow: hidden;
    }
    .spacer { flex: 1; }
    #status {
      color: var(--muted);
      font-size: 12px;
    }
    input[type="range"] {
      accent-color: var(--accent);
      width: 240px;
    }
    .hidden { display: none; }
  </style>
</head>
<body class="" id="body">
  <header>
    <div class="toolbar-group">
      <label>Open</label>
      <input type="file" id="fileInput" accept=".epub" />
    </div>
    <div class="toolbar-group">
      <label>URL</label>
      <input type="text" id="urlInput" placeholder="https://example.com/book.epub" />
      <button id="loadUrlBtn">Load</button>
    </div>
    <div class="toolbar-group">
      <button id="prevBtn" title="Previous (←)">⟵ Prev</button>
      <button id="nextBtn" title="Next (→)">Next ⟶</button>
    </div>
    <div class="toolbar-group">
      <button id="smallerBtn" title="Decrease font size">A−</button>
      <button id="biggerBtn" title="Increase font size">A+</button>
      <button id="themeBtn" title="Toggle theme">Dark</button>
    </div>
    <div class="spacer"></div>
    <div class="toolbar-group">
      <button id="tocToggle">TOC</button>
    </div>
  </header>

  <div id="app">
    <aside id="toc">
      <h3>Contents</h3>
      <ul id="tocList"></ul>
    </aside>
    <main id="viewer"></main>
  </div>

  <footer>
    <div class="toolbar-group">
      <label>Progress</label>
      <input type="range" id="progress" min="0" max="1000" value="0" />
      <span id="percent">0%</span>
    </div>
    <div class="spacer"></div>
    <div id="status">No book loaded</div>
  </footer>

  <script>
    // State
    let book = null;
    let rendition = null;
    let locationsReady = false;
    let currentTheme = 'light';
    let fontSize = 100; // percent

    // Elements
    const fileInput = document.getElementById('fileInput');
    const urlInput = document.getElementById('urlInput');
    const loadUrlBtn = document.getElementById('loadUrlBtn');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const viewer = document.getElementById('viewer');
    const tocEl = document.getElementById('toc');
    const tocList = document.getElementById('tocList');
    const progress = document.getElementById('progress');
    const percent = document.getElementById('percent');
    const status = document.getElementById('status');
    const themeBtn = document.getElementById('themeBtn');
    const tocToggle = document.getElementById('tocToggle');
    const smallerBtn = document.getElementById('smallerBtn');
    const biggerBtn = document.getElementById('biggerBtn');
    const body = document.getElementById('body');

    // Theme registration for the iframe content
    function registerThemes() {
      if (!rendition) return;
      rendition.themes.register('light', {
        'body': { 'background': '#ffffff', 'color': '#111111' },
        'a': { 'color': '#2563eb' }
      });
      rendition.themes.register('dark', {
        'body': { 'background': '#0b0f14', 'color': '#e5e7eb' },
        'a': { 'color': '#60a5fa' }
      });
      rendition.themes.select(currentTheme);
      rendition.themes.fontSize(fontSize + '%');
    }

    function toggleTheme() {
      currentTheme = currentTheme === 'light' ? 'dark' : 'light';
      body.classList.toggle('dark', currentTheme === 'dark');
      themeBtn.textContent = currentTheme === 'dark' ? 'Light' : 'Dark';
      if (rendition) {
        rendition.themes.select(currentTheme);
      }
    }

    function setStatus(text) {
      status.textContent = text;
    }

    function clearTOC() {
      tocList.innerHTML = '';
    }

    function buildTOC(toc) {
      clearTOC();
      const frag = document.createDocumentFragment();
      toc.forEach(item => {
        const li = document.createElement('li');
        const a = document.createElement('a');
        a.href = '#';
        a.textContent = item.label.trim() || item.label || 'Untitled';
        a.addEventListener('click', (e) => {
          e.preventDefault();
          rendition.display(item.href);
        });
        li.appendChild(a);
        // Children (one level for simplicity)
        if (item.subitems && item.subitems.length) {
          const ul = document.createElement('ul');
          item.subitems.forEach(sub => {
            const sli = document.createElement('li');
            const sa = document.createElement('a');
            sa.href = '#';
            sa.style.paddingLeft = '18px';
            sa.textContent = sub.label.trim() || sub.label || 'Untitled';
            sa.addEventListener('click', (e) => {
              e.preventDefault();
              rendition.display(sub.href);
            });
            sli.appendChild(sa);
            ul.appendChild(sli);
          });
          li.appendChild(ul);
        }
        frag.appendChild(li);
      });
      tocList.appendChild(frag);
    }

    async function openBook(input) {
      // Clean up previous
      if (rendition) {
        rendition.destroy();
        rendition = null;
      }
      locationsReady = false;
      progress.value = 0;
      percent.textContent = '0%';
      setStatus('Loading book...');

      // Create the book
      try {
        book = ePub(input);
      } catch (e) {
        console.error(e);
        setStatus('Failed to open book');
        return;
      }

      // Render
      rendition = book.renderTo('viewer', {
        width: '100%',
        height: '100%',
        spread: 'none',
        minSpreadWidth: 1200,
        flow: 'paginated' // change to 'scrolled-doc' if you prefer scrolling
      });
      registerThemes();
      rendition.display();

      // Keyboard navigation
      document.onkeydown = (e) => {
        if (e.key === 'ArrowRight') rendition.next();
        if (e.key === 'ArrowLeft') rendition.prev();
      };

      // Build TOC
      try {
        const nav = await book.loaded.navigation;
        buildTOC(nav.toc || []);
      } catch (e) {
        console.warn('No navigation found', e);
        clearTOC();
      }

      // Generate locations for percentage/progress
      try {
        await book.ready;
        await book.locations.generate(1000);
        locationsReady = true;
      } catch (e) {
        console.warn('Locations could not be generated', e);
        locationsReady = false;
      }

      // Update status on relocate
      rendition.on('relocated', (loc) => {
        let pct = 0;
        if (locationsReady && loc && loc.start && loc.start.cfi) {
          pct = book.locations.percentageFromCfi(loc.start.cfi) || 0;
          progress.value = Math.round(pct * 1000);
        }
        percent.textContent = Math.round(pct * 100) + '%';

        const item = loc.start && loc.start.href ? book.navigation.get(loc.start.href) : null;
        const chapter = (item && item.label) ? item.label : '—';
        setStatus('Chapter: ' + chapter);
      });

      setStatus('Ready');
    }

    // Controls
    fileInput.addEventListener('change', (e) => {
      const file = e.target.files && e.target.files[0];
      if (file) openBook(file);
    });

    loadUrlBtn.addEventListener('click', () => {
      const url = urlInput.value.trim();
      if (url) openBook(url);
    });

    prevBtn.addEventListener('click', () => rendition && rendition.prev());
    nextBtn.addEventListener('click', () => rendition && rendition.next());

    smallerBtn.addEventListener('click', () => {
      fontSize = Math.max(70, fontSize - 10);
      if (rendition) rendition.themes.fontSize(fontSize + '%');
    });
    biggerBtn.addEventListener('click', () => {
      fontSize = Math.min(200, fontSize + 10);
      if (rendition) rendition.themes.fontSize(fontSize + '%');
    });

    themeBtn.addEventListener('click', toggleTheme);

    tocToggle.addEventListener('click', () => {
      const hidden = tocEl.classList.toggle('hidden');
      document.getElementById('app').style.gridTemplateColumns = hidden ? '0 1fr' : '280px 1fr';
    });

    progress.addEventListener('input', (e) => {
      if (!book || !locationsReady) return;
      const val = parseInt(e.target.value, 10) / 1000;
      const cfi = book.locations.cfiFromPercentage(val);
      if (cfi) rendition.display(cfi);
    });

    // Optional: start in dark if system prefers
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
      currentTheme = 'dark';
      body.classList.add('dark');
      themeBtn.textContent = 'Light';
    }

    // Tip: load a default sample by URL (comment out if not desired)
    // openBook('https://standardebooks.org/ebooks/jane-austen/pride-and-prejudice/epub3/standardebooks-pride-and-prejudice.epub');
    // openBook('https://www.gutenberg.org/cache/epub/9499/pg9499-images-3.epub');
    // openBook('https://superdb-api.superbem.workers.dev/epub?url=https://www.gutenberg.org/cache/epub/9499/pg9499-images-3.epub');

const workerBase = "https://superdb-api.superbem.workers.dev/epub?url=";
const gutenbergUrl = "https://www.gutenberg.org/cache/epub/9499/pg9499-images-3.epub";

openBook(workerBase + encodeURIComponent(gutenbergUrl));


//     async function getFinalURL(fileURL) {
//   const response = await fetch(fileURL, {
//     method: 'HEAD', // Only request headers, no body
//     redirect: 'follow' // Follow redirects automatically
//   });

//   return response.url; // This is the final resolved URL
// }

// // Usage:
// getFinalURL('https://www.gutenberg.org/ebooks/'+9999+'.epub3.images')
//   .then(finalURL => {
//     console.log('Final URL:', finalURL);
//   })
//   .catch(err => {
//     console.error('Error:', err);
//   });

  </script>
</body>
</html>
