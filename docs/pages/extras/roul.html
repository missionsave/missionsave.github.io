<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Roulette Matrix Optimizer</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, sans-serif;
      background: #0f0f0f;
      color: #e0e0e0;
      margin: 0;
      padding: 10px;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .panel {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(10, 1fr);
      gap: 5px;
      margin-bottom: 10px;
    }
    button.num {
      padding: 10px;
      background: #252525;
      color: #eee;
      border: 1px solid #333;
      border-radius: 4px;
      font-weight: bold;
    }
    button.zero { background: #0a5c0a; }
    button.red { color: #ff5252; }
    .controls {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }
    button.ctrl {
      flex: 1;
      padding: 8px;
      background: #333;
      color: #bbb;
      border: none;
      border-radius: 4px;
    }
    .history-box {
      background: #000;
      border: 1px solid #222;
      padding: 8px;
      font-family: monospace;
      white-space: nowrap;
      overflow-x: auto;
    }
    .trend-bar {
      background: #222;
      border: 1px solid #444;
      border-radius: 4px;
      padding: 8px;
      margin-bottom: 5px;
      display: flex;
      gap: 10px;
    }
    .trend-label {
      font-size: 0.65rem;
      color: #888;
      font-weight: bold;
    }
    #trend-data {
      color: #ffeb3b;
      font-weight: bold;
    }
    .matrix-wrapper {
      flex-grow: 1;
      overflow: auto;
      border: 1px solid #333;
      background: #141414;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.75rem;
    }
    th, td {
      border: 1px solid #222;
      padding: 4px;
      text-align: center;
    }
    th {
      background: #222;
      color: #888;
      position: sticky;
      top: 0;
    }
    .idx-col {
      width: 30px;
      background: #000;
      color: #444;
    }
    .sum-col {
      width: 35px;
      background: #1a1a1a;
      color: #fff;
      font-weight: bold;
    }
    .hot-pick {
      background: #1b4d1b;
      color: #fff !important;
      font-weight: bold;
    }
    .red-txt { color: #ff5252; }
    .green-txt { color: #4caf50; }
    .black-txt { color: #aaa; }
    .sum-high { background: #5c0a0a; }
    .sum-mid { background: #3d3400; color: #ffeb3b; }
    .trend-strength {
      width: 100%;
      height: 12px;
      background: linear-gradient(to right, #1b4d1b, #4caf50);
      border-radius: 4px;
      margin-top: 2px;
    }
    .trend-weak .trend-strength { opacity: 0.3; }
    .trend-medium .trend-strength { opacity: 0.6; }
    .trend-strong .trend-strength { opacity: 1.0; }
  </style>
</head>
<body>

<div class="panel">
  <div class="grid" id="buttons-grid"></div>
  <div class="controls">
    <button class="ctrl" id="undo-btn">Undo</button>
    <button class="ctrl" id="reset-btn">Full Reset</button>
    <button class="ctrl" id="reshuffle-btn">Reshuffle</button>
  </div>
  <div class="history-box" id="history-display"></div>
</div>

<div class="trend-bar">
  <span class="trend-label">Top 10 Index:</span>
  <span id="trend-data">Waiting…</span>
  <span class="trend-label" id="trend-stats"></span>
</div>

<div class="matrix-wrapper">
  <table>
    <thead>
      <tr id="header-row"></tr>
    </thead>
    <tbody id="table-body"></tbody>
  </table>
</div>

<script>
/* ===== CONFIG ===== */
const REDS = [1, 3, 5, 7, 9, 12, 14, 16, 18, 19, 21, 23, 25, 27, 30, 32, 34, 36];
const STD_WHEEL = [0, 32, 15, 19, 4, 21, 2, 25, 17, 34, 6, 27, 13, 36, 11, 30, 8, 23, 10, 5, 24, 16, 33, 1, 20, 14, 31, 9, 22, 18, 29, 7, 28, 12, 35, 3, 26];
const BASE_NUMS = [...Array(37).keys()];
const RND_COUNT = 1000;
const DISPLAY_LIMIT = 50;
const STORAGE_KEY = 'roulette_optimizer_data';
const WINDOW_SIZE = 7; // Config: Window size for trend calculation
const MIN_HISTORY = 8; // Config: Minimum history length before calculation

/* ===== STATE ===== */
let state = { history: [], rndSets: [] };
let debounceTimer = null;

/* ===== SHUFFLE ===== */
function shuffle(a) {
  a = [...a];
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.random() * (i + 1) | 0;
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

/* ===== WORKER ===== */
const worker = new Worker(URL.createObjectURL(new Blob([`
  let wheels = [];
  onmessage = e => {
    if (e.data.type === 'init') {
      wheels = e.data.wheels;
      return;
    }
    const history = e.data.history;
    const BASE = [...Array(37).keys()];
    const WINDOW_SIZE = ${WINDOW_SIZE};
    const MIN_HISTORY = ${MIN_HISTORY};

    function getTop4(h, w) {
      if (h.length < MIN_HISTORY) return [];
      const m = {};
      w.forEach((n, i) => m[n] = i);
      const s = Array(37).fill(0);
      const windowSize = Math.min(WINDOW_SIZE, h.length);
      const totalWeight = windowSize * (windowSize + 1) / 2;

      h.slice(-windowSize).forEach((n, ix) => {
        const wt = (windowSize - ix) / totalWeight;
        const c = m[n];
        for (let o = -2; o <= 2; o++) {
          const i = (c + o + 37) % 37;
          s[w[i]] += wt * (1 - Math.abs(o) * 0.2);
        }
      });
      return BASE.map(n => ({ n, s: s[n] }))
        .sort((a, b) => b.s - a.s)
        .slice(0, 2)
        .map(x => x.n);
    }

    if (history.length >= MIN_HISTORY) {
      const allHots = wheels.map(w => getTop4(history, w));
      const sums = [];
      for (let i = 0; i < 37; i++) {
        let sum = 0;
        wheels.forEach((w, c) => { if (allHots[c].includes(w[i])) sum++; });
        sums.push(sum);
      }
      const trend = sums.map((s, i) => ({ i, s }))
        .filter(x => x.s > 0)
        .sort((a, b) => b.s - a.s)
        .slice(0, 10)
        .map(x => x.i);

      const stdDev = Math.sqrt(sums.reduce((sq, n) => sq + Math.pow(n - (sums.reduce((a, b) => a + b, 0) / sums.length), 2), 0) / sums.length);

      postMessage({ allHots, sums, trend, stdDev });
    } else {
      postMessage({ allHots: [], sums: [], trend: [], stdDev: 0 });
    }
  };
`], { type: 'application/javascript' })));

/* ===== UI RENDER ===== */
function render(historyOnly = false) {
  const h = document.getElementById('history-display');
  h.innerHTML = state.history.map(n => `<span class="${n === 0 ? 'green-txt' : REDS.includes(n) ? 'red-txt' : 'black-txt'}">${n}</span>`).join(' ');
  h.scrollLeft = h.scrollWidth;
  if (!historyOnly) {
    document.getElementById('trend-data').textContent = state.history.length >= MIN_HISTORY ? 'Calculating…' : 'Waiting for more history…';
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(() => {
      worker.postMessage({ type: 'update', history: state.history });
    }, 300);
  }
}

worker.onmessage = e => {
  if (e.data.trend.length > 0) {
    document.getElementById('trend-data').textContent = e.data.trend.join(' — ');
    document.getElementById('trend-stats').textContent = `Confidence: ${e.data.stdDev.toFixed(2)}`;
    renderTable(e.data.allHots, e.data.sums);
  } else {
    document.getElementById('trend-data').textContent = 'Waiting for more history…';
    document.getElementById('trend-stats').textContent = '';
  }
};

function renderTable(allHots, sums) {
  const header = document.getElementById('header-row');
  header.innerHTML = '<th class="idx-col">#</th><th class="sum-col">Σ</th><th>STD</th>' +
    state.rndSets.slice(0, DISPLAY_LIMIT).map((_, i) => `<th>R${i + 1}</th>`).join('');
  const tbody = document.getElementById('table-body');
  tbody.innerHTML = '';
  const wheels = [STD_WHEEL, ...state.rndSets.slice(0, DISPLAY_LIMIT)];
  for (let i = 0; i < 37; i++) {
    let row = `<td class="idx-col">${i}</td><td class="sum-col ${sums[i] >= 4 ? 'sum-high' : sums[i] >= 2 ? 'sum-mid' : ''}">${sums[i]}</td>`;
    wheels.forEach((w, c) => {
      const n = w[i];
      const hot = allHots[c].includes(n);
      const col = n === 0 ? 'green-txt' : REDS.includes(n) ? 'red-txt' : 'black-txt';
      const trendClass = sums[i] >= 4 ? 'trend-strong' : sums[i] >= 2 ? 'trend-medium' : 'trend-weak';
      row += `<td class="${hot ? 'hot-pick' : col} ${trendClass}"><div>${n}</div><div class="trend-strength" style="width: ${Math.min(100, sums[i] * 10)}%"></div></td>`;
    });
    tbody.insertAdjacentHTML('beforeend', '<tr>' + row + '</tr>');
  }
}

/* ===== INIT ===== */
function save() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify({ history: state.history }));
}

function init() {
  const saved = localStorage.getItem(STORAGE_KEY);
  state = { history: [], rndSets: [] };
  if (saved) {
    try {
      const parsed = JSON.parse(saved);
      if (Array.isArray(parsed.history)) {
        state.history = parsed.history;
      }
    } catch (e) {
      console.warn('Invalid saved data, ignoring');
    }
  }
  state.rndSets = Array.from({ length: RND_COUNT }, () => shuffle(BASE_NUMS));
  worker.postMessage({ type: 'init', wheels: [STD_WHEEL, ...state.rndSets] });

  const grid = document.getElementById('buttons-grid');
  grid.innerHTML = '';
  BASE_NUMS.forEach(n => {
    const b = document.createElement('button');
    b.textContent = n;
    b.className = `num ${n === 0 ? 'zero' : REDS.includes(n) ? 'red' : ''}`;
    b.onclick = () => {
      state.history.push(n);
      save();
      render();
    };
    grid.appendChild(b);
  });

  document.getElementById('undo-btn').onclick = () => {
    if (state.history.length) {
      state.history.pop();
      save();
      render();
    }
  };

  document.getElementById('reset-btn').onclick = () => {
    if (confirm('Full Reset?')) {
      state.history = [];
      state.rndSets = Array.from({ length: RND_COUNT }, () => shuffle(BASE_NUMS));
      save();
      worker.postMessage({ type: 'init', wheels: [STD_WHEEL, ...state.rndSets] });
      render();
    }
  };

  document.getElementById('reshuffle-btn').onclick = () => {
    state.rndSets = Array.from({ length: RND_COUNT }, () => shuffle(BASE_NUMS));
    worker.postMessage({ type: 'init', wheels: [STD_WHEEL, ...state.rndSets] });
    render();
  };

  render();
}

init();
</script>
</body>
</html>
