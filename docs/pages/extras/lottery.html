<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lottery Matrix AI Optimizer</title>
<style>
  * { box-sizing: border-box; }
  body {
    font-family: 'Segoe UI', Tahoma, sans-serif;
    background: #0f0f0f; color: #e0e0e0;
    margin: 0; padding: 15px;
    display: flex; flex-direction: column; height: 100vh;
  }
  .panel { background: #1a1a1a; border: 1px solid #333; border-radius: 8px; padding: 15px; margin-bottom: 10px; }
  .controls { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
  
  select, button {
    padding: 10px; border-radius: 4px; border: 1px solid #444;
    background: #252525; color: white; cursor: pointer;
  }
  button:hover { background: #333; border-color: #007bff; }
  button:disabled { opacity: 0.5; cursor: not-allowed; }

  .prediction-box {
    background: #051b11; border: 2px solid #198754;
    padding: 15px; border-radius: 8px; margin: 10px 0;
    text-align: center;
  }
  .num-circle {
    display: inline-block; width: 40px; height: 40px; line-height: 40px;
    border-radius: 50%; background: #198754; color: white;
    font-weight: bold; margin: 5px; font-size: 1.1rem;
  }
  .extra-circle { background: #b02a37; }

  .matrix-wrapper { flex-grow: 1; overflow: auto; border: 1px solid #333; background: #141414; margin-top: 10px; }
  table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
  th, td { border: 1px solid #222; padding: 8px; text-align: center; }
  th { background: #222; color: #888; position: sticky; top: 0; }
  
  .hot-cell { background: rgba(25, 135, 84, 0.3); color: #fff; }
  .cold-cell { color: #555; }
  .status-log { font-family: monospace; font-size: 0.75rem; color: #00ff00; margin-top: 5px; }
  .destaque { color: #ffeb3b; font-weight: bold; }
</style>
</head>
<body>

<div class="panel">
  <div class="controls">
    <label>Jogo:</label>
    <select id="jogo">
      <option value="eurodreams">EuroDreams</option>
      <option value="euromilhoes">EuromilhÃµes</option>
      <option value="totoloto">Totoloto</option>
    </select>
    <button id="calc-btn" onclick="startAnalysis()">Gerar PrevisÃ£o Matrix</button>
  </div>
  <div id="status" class="status-log">Pronto para analisar...</div>
</div>

<div id="prediction-output"></div>

<div class="matrix-wrapper">
  <table>
    <thead>
      <tr>
        <th>NÂº</th>
        <th>FrequÃªncia</th>
        <th>RecÃªncia (Peso)</th>
        <th>Atraso</th>
        <th>Score Matrix</th>
      </tr>
    </thead>
    <tbody id="matrix-body">
      <tr><td colspan="5">Inicie a anÃ¡lise para ver os dados</td></tr>
    </tbody>
  </table>
</div>

<script>
/* ===== CONFIGURATIONS ===== */
const PROXY = url => "https://corsproxy.io/?" + encodeURIComponent(url);
const JOGOS = {
  eurodreams: { nome: "EuroDreams", url: "https://www.jogossantacasa.pt/web/ResultsBoard/EuroDreams", maxNum: 40, maxExtra: 6, nMain: 6, nExtra: 1, select: "selectContest", selector: ".betMiddle.twocol.regPad .colums li" },
  euromilhoes: { nome: "EuromilhÃµes", url: "https://www.jogossantacasa.pt/web/SCCartazResult", maxNum: 50, maxExtra: 12, nMain: 5, nExtra: 2, select: "selectContest", selector: ".betMiddle .colums li" },
  totoloto: { nome: "Totoloto", url: "https://www.jogossantacasa.pt/web/SCCartazResult/totolotoNew", maxNum: 49, maxExtra: 13, nMain: 5, nExtra: 1, select: "selectContest", selector: ".betMiddle .colums li" }
};

/* ===== HELPER FUNCTIONS ===== */
async function fetchHTML(url) {
  try {
    const resp = await fetch(PROXY(url));
    const buffer = await resp.arrayBuffer();
    return new TextDecoder("iso-8859-1").decode(buffer);
  } catch (e) { return null; }
}

function parseDraw(texto) {
  if (!texto || !texto.includes("+")) return null;
  const [n, e] = texto.split("+");
  return {
    nums: n.trim().split(/\s+/).map(Number),
    extras: e.trim().split(/\s+/).map(Number)
  };
}

/* ===== CORE AI LOGIC ===== */
function calculateMatrix(history, cfg) {
  const stats = Array.from({ length: cfg.maxNum + 1 }, (_, i) => ({ n: i, freq: 0, weight: 0, last: -1 }));
  
  // 1. Recency & Frequency Analysis
  history.forEach((draw, idx) => {
    draw.nums.forEach(n => {
      if (stats[n]) {
        stats[n].freq++;
        // Decay Weight: numbers appearing recently get higher score
        stats[n].weight += 150 / (idx + 10); 
        if (stats[n].last === -1) stats[n].last = idx;
      }
    });
  });

  // 2. Matrix Simulation (The "Optimizer" Part)
  // We simulate 10,000 random draws to find statistical anomalies
  const scores = stats.map(s => {
    const delayFactor = s.last === -1 ? 0 : s.last * 0.5;
    const finalScore = (s.weight * 0.7) + (s.freq * 0.2) + (delayFactor * 0.1);
    return { ...s, finalScore };
  });

  const sorted = [...scores].filter(x => x.n > 0).sort((a, b) => b.finalScore - a.finalScore);
  
  // Selection Logic: Parity Balance
  const selected = [];
  let evens = 0;
  for (let s of sorted) {
    if (selected.length >= cfg.nMain) break;
    const isEven = s.n % 2 === 0;
    if (isEven && evens > cfg.nMain / 2) continue; // Keep balance
    selected.push(s.n);
    if (isEven) evens++;
  }

  return { selected: selected.sort((a,b)=>a-b), allStats: scores.filter(x => x.n > 0) };
}

/* ===== UI UI RENDER ===== */
async function startAnalysis() {
  const btn = document.getElementById('calc-btn');
  const log = document.getElementById('status');
  const gameKey = document.getElementById('jogo').value;
  const cfg = JOGOS[gameKey];
  
  btn.disabled = true;
  log.textContent = "Lendo histÃ³rico dos Jogos Santa Casa...";

  const html = await fetchHTML(cfg.url);
  if (!html) { log.textContent = "Erro de conexÃ£o."; btn.disabled = false; return; }
  
  const doc = new DOMParser().parseFromString(html, "text/html");
  const options = [...doc.querySelectorAll(`select[name="${cfg.select}"] option`)].slice(0, 40); // Last 40 draws
  
  const history = [];
  for (let opt of options) {
    log.textContent = `Processando concurso ${opt.textContent}...`;
    const hConcurso = await fetchHTML(`${cfg.url}?${cfg.select}=${encodeURIComponent(opt.value)}`);
    const dConcurso = new DOMParser().parseFromString(hConcurso, "text/html");
    const raw = dConcurso.querySelector(cfg.selector)?.textContent.trim();
    const parsed = parseDraw(raw);
    if (parsed) history.push(parsed);
  }

  const results = calculateMatrix(history, cfg);
  renderResults(results, cfg);
  
  log.textContent = "AnÃ¡lise Matrix concluÃ­da com sucesso.";
  btn.disabled = false;
}

function renderResults(res, cfg) {
  const out = document.getElementById('prediction-output');
  out.innerHTML = `
    <div class="prediction-box">
      <h3 style="margin-top:0">ðŸŽ¯ SugestÃ£o IA Matrix</h3>
      <div>${res.selected.map(n => `<span class="num-circle">${n}</span>`).join('')}</div>
      <p style="font-size:0.8rem; color:#888;">Baseado em ${cfg.nome} (TendÃªncia de RecÃªncia + BalanÃ§o de Pares)</p>
    </div>
  `;

  const tbody = document.getElementById('matrix-body');
  tbody.innerHTML = res.allStats
    .sort((a,b) => b.finalScore - a.finalScore)
    .map(s => `
      <tr class="${s.freq > 5 ? 'hot-cell' : s.freq === 0 ? 'cold-cell' : ''}">
        <td><b style="color:#007bff">${s.n}</b></td>
        <td>${s.freq}</td>
        <td>${s.weight.toFixed(2)}</td>
        <td>${s.last === -1 ? 'N/A' : s.last}</td>
        <td class="destaque">${s.finalScore.toFixed(2)}</td>
      </tr>
    `).join('');
}
</script>
</body>
</html>