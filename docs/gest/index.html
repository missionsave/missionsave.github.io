
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Gest</title>
<link rel="shortcut icon" href="../favicon.png">

<script>
/* ====== CONFIG ====== */
const ENDPOINT = "https://superdb-api.superbem.workers.dev/sql";
let data_table = "tabGest";
var head = [];
let tableobj = [];
let apikey="";
const headers = { "Content-Type": "application/json" };
var email_autorized=0;


async function isKeyValid(key) {
    const resp = await fetch(ENDPOINT, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + key
      },
      body: JSON.stringify({
        sql: "PRAGMA table_info(tabGest)", // any auth‑protected query
        params: []
      })
    });
	console.log("resp",resp.status);
    if (resp.status === 401) {
      // Auth layer rejected it
      return false;
    }
	if(resp.status===200){
		return true;
	}
	return false;
}

async function checklogin(valuekey) {
  console.log("Checking key:", valuekey);

  try {
    const valid = await isKeyValid(valuekey); // wait for the async call

    if (valid) {
      console.log("✅ Key is valid");
      headers["Authorization"] = "Bearer " + valuekey;
      apikey = valuekey; // store if needed
	  email_autorized=1;
	  addsqlt();
    } else {
      console.warn("❌ Invalid key");
    }
  } catch (err) {
    console.error("Error validating key:", err);
  }
}


/* ====== CORE API ====== */
async function apiSQL(sql, params = []) {
  const resp = await fetch(ENDPOINT, {
    method: "POST",
    headers,
    body: JSON.stringify({ sql, params })
  });
  
  const data = await resp.json();
  
  if (!resp.ok || data.success === false) {
    throw new Error(data.error || `Erro HTTP ${resp.status}`);
  }
  
  return data.rows || [];
}
async function apiSQL_v1(sql, params = []) {
	
  const resp = await fetch(ENDPOINT, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ sql, params })
  });
  const data = await resp.json();
  if (!resp.ok || data.success === false) {
    throw new Error(data.error || `Erro HTTP ${resp.status}`);
  }
  return data.rows || [];
}

/* ====== FUNÇÕES ADAPTADAS ====== */
async function addtables(){
  const rows = await apiSQL("SELECT name FROM sqlite_master WHERE type='table' AND name NOT LIKE 'sqlite_%' ORDER BY name");
  const x = document.getElementById("tables");
  x.innerHTML = "";
  rows.forEach(r=>{
    const o=document.createElement("option");
    o.text=r.name; o.value=r.name; x.add(o);
  });
}

async function addsqlt(){
  const rows = await apiSQL("SELECT * FROM tabSql ORDER BY descr ASC");
  const x = document.getElementById("selsql");
  x.innerHTML="";
  rows.forEach(r=>{
    const o=document.createElement("option");
    o.text=r.descr;
    o.value=`${r.descr}$split${r.sqlt}$split${r.autorun}`;
    x.add(o);
  });
}
  function inferTableFromSQL(sql) {
    const m = /\bfrom\s+([^\s;]+)/i.exec(sql);
    return m ? m[1].replace(/["`]/g, "") : "";
  }
    async function getSchema(table) {
    const { rows } = await api(`PRAGMA table_info(${table})`);
    head = rows.map(r => ({ name: r.name }));
    // Atualiza lista de campos
    const sel = document.getElementById("selfields");
    sel.innerHTML = "";
    for (const c of head) {
      const opt = document.createElement("option");
      opt.textContent = c.name;
      opt.value = c.name;
      sel.appendChild(opt);
    }
  }
    function renderTable(rows) {
    const wrapper = document.getElementById("wrapper");
    if (!rows || rows.length === 0) {
      wrapper.innerHTML = `<div style="padding:10px;">Sem resultados.</div>`;
      return;
    }

    // HEAD: se não vier de PRAGMA, inferir das chaves
    if (!head || head.length === 0) {
      const keys = Object.keys(rows[0] || {});
      head = keys.map(k => ({ name: k }));
    }

    let html = "";
    html += `<table class="fixed" border="1" cellpadding="0" cellspacing="0" id="${data_table}">`;
    html += `<col width="70" /><col width="50" />`;
    html += `<tr><td style="width:150px;"></td>`;
    for (const c of head) html += `<td>${c.name}</td>`;
    html += `</tr>`;

    // Linha de insert
    html += geninsertrow();

    for (let i = 0; i < rows.length; i++) {
      const rowIndex = i + 1;
      const bid = data_table + rowIndex;
      html += `<tr id="row${bid}">`;
      html += genbuttons(rowIndex, rows[i]);
      for (const c of head) {
        html += genreg(data_table, c.name, rowIndex, rows[i][c.name]);
      }
      html += `</tr>`;
    }
    html += `</table>`;

    wrapper.innerHTML = html;
    if (!adminEnabled || !ADMIN_TOKEN) {
      // Oculta botões de edição/deleção
      for (const el of document.getElementsByClassName("edit")) el.style.display = "none";
      for (const el of document.getElementsByClassName("delete")) el.style.display = "none";
    }
  }

    function wantsWrite(sql) {
    return /^\s*(insert|update|delete|create|drop|alter|replace|pragma|attach|vacuum|begin|commit|rollback)\b/i.test(sql);
  }
    async function api(sql, params = []) {
    const headers = { "Content-Type": "application/json" };
    if (wantsWrite(sql) && adminEnabled && ADMIN_TOKEN) {
      headers["Authorization"] = "Bearer " + ADMIN_TOKEN;
    }
    const resp = await fetch(ENDPOINT, {
      method: "POST",
      headers,
      body: JSON.stringify({ sql, params })
    });
    const data = await resp.json().catch(() => ({}));
    if (!resp.ok || data.success === false) {
      throw new Error((data && data.error) || `HTTP ${resp.status}`);
    }
    return data;
  }
async function getdata(sql) {
  const tableMatch = /\bfrom\s+([^\s;]+)/i.exec(sql);
  if (!tableMatch) {
    alert("Não foi possível detectar o nome da tabela.");
    return;
  }
  data_table = tableMatch[1];

  // 1️⃣ Consulta real dos dados
  const dataResp = await fetch(ENDPOINT, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ sql, params: [] })
  });
  const data = await dataResp.json();
  if (!data.success || !Array.isArray(data.rows)) {
    alert("Erro ao buscar dados da tabela.");
    return;
  }

  tableobj = data.rows;

  // 2️⃣ Extrai colunas a partir do primeiro registro
  if (tableobj.length > 0) {
    head = Object.keys(tableobj[0]).map(name => ({ name }));
  } else {
    alert("Tabela sem dados.");
    return;
  }

  // 3️⃣ Monta cabeçalho da tabela
  let html = `<table class='fixed' border='1' cellpadding='0' cellspacing='0' id='${data_table}'>
    <col width='70'><col width='50'><tr><td style='width:150px;'></td>`;
  for (let i = 0; i < head.length; i++) {
    html += `<td>${head[i].name}</td>`;
  }
  html += `</tr></table>`;
  document.getElementById("wrapper").innerHTML = html;

  // 4️⃣ Linha de inserção
  if (data_table !== "data_table") geninsertrow(head, data_table);

  // 5️⃣ Renderiza linhas
  for (let i = 0; i < tableobj.length; i++) {
    const id = i + 1;
    const bid = data_table + id;
    let rowHTML = `<tr id="row${bid}">`;
    rowHTML += genbuttons(id);
    for (let j = 0; j < head.length; j++) {
      const colName = head[j].name;
      rowHTML += genreg(data_table, colName, id, tableobj[i][colName]);
    }
    rowHTML += `</tr>`;
    const table = document.getElementById(data_table);
    table.insertAdjacentHTML("beforeend", rowHTML);
  }

  // 6️⃣ Oculta botões se não autorizado
  if (!email_autorized) {
    const edits = document.getElementsByClassName("edit");
    const deletes = document.getElementsByClassName("delete");
    for (let i = 0; i < edits.length; i++) edits[i].style.display = "none";
    for (let i = 0; i < deletes.length; i++) deletes[i].style.display = "none";
  }
}



async function saverow(dt,id){
  const bid = dt+id;
  const vals=[];
  for(let h of head){
    const v = document.getElementById("txtarea"+bid+h.name).value.replace(/'/g,'"');
    vals.push(v);
    tableobj[id-1][h.name]=v;
    document.getElementById("txtarea"+bid+h.name).outerHTML = genlink(h.name,v);
  }
  const setC = head.map(h=>`${h.name}=?`).join(",");
  const rowid = tableobj[id-1].id;
  await apiSQL(`UPDATE ${dt} SET ${setC} WHERE id = ?`,[...vals,rowid]);
  document.getElementById("edit_button"+bid).style.display="block";
  document.getElementById("save_button"+bid).style.display="none";
}

async function insertrow(){
  const names=[], vals=[];
  head.forEach(h=>{
    const v = document.getElementById("new"+h.name).value.replace(/['"]/g,'`');
    if(v!==""){names.push(h.name); vals.push(v);}
  });
  if(!names.length) return;
  const ph = names.map(()=>"?").join(",");
  await apiSQL(`INSERT INTO ${data_table} (${names.join(",")}) VALUES (${ph})`,vals);
  runsql();
} 

</script>
<script>
 

 
function editrow(data_table,id){ 
	var bid=data_table+id;
	// console.log(data_table,id);
	
	document.getElementById("edit_button"+bid).style.display="none";
	document.getElementById("save_button"+bid).style.display="block";
	
	for(var i=0;i<head.length;i++){
		var namefield=head[i]['name'];
		var reg=document.getElementById(data_table+namefield+id);
		var bidn=bid+namefield;
		var h="";
		h="<textarea autocomplete='on' id='txtarea$id' style='background-color:orange; resize:none; width:100%;' type='text' >";
		h+=tableobj[id-1][ namefield];
		h+="</textarea>";
		h=h.split("$id").join(bidn);
		reg.innerHTML=h;
		
	} 
}

function deleterow(data_table,id){ 
	var bid=data_table+id;
	document.getElementById("row"+bid+"").outerHTML="";
}

//dont send empty values (for predef mysql)

function geninsertrow(head,data_table){
	// var html="<tr>";
	// html+='<td><input type="button" class="add" onclick="insertrow();" value="Add Row"></td>';
	// for(var i=0;i<head.length;i++)
		// html+='<td><input style="width:100%;" type="text" id="new'+head[i]['name']+'"></td>';
	// html+="</tr>";
	var html="<tr>";
	html+='<td><input id="add_row" type="button" class="add" onclick="insertrow();" value="Add Row"></td>';
	for(var i=0;i<head.length;i++)
		html+='<td><input style="width:100%;" type="text" id="new'+head[i]['name']+'"></td>';
	html+="</tr>";
	

	var table=document.getElementById(data_table);
	var table_len=(table.rows.length)-0;
	var row = table.insertRow(table_len).outerHTML=html;

	if(!email_autorized){
		add_row.style.display="none";
		// txtsql.style.display="none";
	}
}

function genbuttons(id){
	var bid=data_table+id;
	var h='<td style="width:150px;"><input style="float:left;" type="button" id="edit_button$bid" value="E" class="edit" onclick="editrow(`data_table`,$id)">';
	h+='<input style="float:left;" type="button" id="save_button$bid" value="S" class="save" onclick="saverow(`data_table`,$id)">'; 
	h+='<input style="float:left;" type="button" value="D" class="delete" onclick="deleterow(`data_table`,$id)">';
	h+='</td>';
	h=h.split("data_table").join(data_table);
	h=h.split("$id").join(id);
	h=h.split("$bid").join(bid);
	return h;
}

function genlink(field,vals){
if (field === "link") {
    // normalize to real newlines
    // vals = vals.replace(/\/n/g, "\n");   // case 1
    vals = vals.replace(/\\n/g, "\n"); // case 2

    console.log(JSON.stringify(vals)); // sanity check

    var val = vals.split("\n");
    var html = "";

    for (var i = 0; i < val.length; i++) {
        var matches = val[i].match(/^https?\:\/\/([^\/?#]+)(?:[\/?#]|$)/i);
        var h = matches && matches[1];
        if (h) {
            h = h.replace(/^www\./, "");
            var parts = h.split(".");
            h = (parts.length === 3) ? parts[0] + parts[1] : parts[0];
            html += `<a href="${val[i]}" target="_blank">${h}</a> `;
        }
    }
    return html || vals;
}

	if(field=="data"){
		var date = new Date(vals); 
		if(date!="Invalid Date"){
			var fdate = date.toISOString().slice(0,10);
			return fdate;
		} 
	}
	return vals;
}

function genreg(data_table,field,id,val){ 
	var html="";
	html+="<td id='"+data_table+field+id+"'>";
	html+= genlink(field,val);
	html+="</td>";
	return html;
}

// getdata('select * from tabzall order by id desc');
getdata('select * from tabGest order by id desc LIMIT 50');
// getdata('select * from tabPontos order by id desc');
 

 
function tablechange(val){
	console.log(val);
}

 
function changesql(val){
	var sql=val.split("$split")[1];
	var tsql=document.getElementById("txtsql");
	tsql.value=sql;
	var descr=val.split("$split")[0];
	var tdescrsql=document.getElementById("descrsql");
	tdescrsql.value=descr;
	var autorun=val.split("$split")[2];
	var tautorun=document.getElementById("autorun");
	tautorun.checked=Number(autorun); 
	if(autorun==1)runsql();
}

function runsql(){
	var tsql=document.getElementById("txtsql").value;
	var sql=tsql.split(";")[0];
	sql=sql.split("`").join('"');
	var dt=sql.split("from")[1];
	if(dt){
		dt=dt.trim();
		if(dt.split(" ").length>1)dt=dt.split(" ")[0].trim(); 
	}else dt="";
	data_table="data_table";
	if(dt!="")data_table=dt;
	getdata(sql);
	
	// addsqlt();
	// CREATE TABLE if not exists `tabSql` ( `id` int(11) NOT NULL AUTO_INCREMENT, `date` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP, `descr` varchar(256) COLLATE utf8_unicode_ci NOT NULL DEFAULT '', `sqlt` text CHARACTER SET utf8 COLLATE utf8_unicode_ci NOT NULL, PRIMARY KEY (`id`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci
	
}
function savesql(){

}
</script>
<style>
body
{
margin:0px; auto;
padding:0px;
font-family:helvetica;
}
#wrapper
{
  width:995px;
  padding:0px;
  margin:0px auto;
  font-family:helvetica;
  text-align:center;
}
h1
{
  text-align:center;
  font-size:35px;
  color:#2E2E2E;
  padding:10px;
}
h1 p
{
	font-size:20px;
	margin:0px;
	color:#585858;
}
td
{
	// width:150px;
	text-align:center;
}
input[type="button"]
{
	// margin-top:5px;
}
.save
{
	float:left;
	display:none;
}
table.fixed {
      table-layout: fixed;
      width: 100%;
    }
    table.fixed td {
      overflow: hidden;
    }
tr:nth-child(even) {
  background-color: #f0f0f0;
}
.left_fixed {
	position: fixed;
	z-index:1;
	width: 16%;
	top: 0px;
	bottom: 0px;
	left: 0px;
	// background-color: #0412303f; 
	min-width: 170px;
}
.right_side {
	width: 100%; 
	height: 100vh;
	float: right;
	max-width: calc(100% - 170px);
}
.top_side {
	position: fixed;
	// grid-area: 1 / 1;
	z-index:1;
	width: 100%;
	top: 0px; 
	left: 175px;
	background-color: gray;
	min-height: 140px;
	display: flex;
  flex-flow: row wrap;
}
#wrapper{
	top:140px;
	position: relative; 
}
</style>
</head>

<body>

<div class="left_fixed" style=" border-style: solid; min-height:10px; width:100px;">
	<select id="tables" size="5" onchange="tablechange(value);" style="min-width:170px;">
	</select>
	<select id="selfields" size="8" onchange="tablechange(value);" style="min-width:170px;">
	</select>
	<select id="selsql" size="8" onchange="changesql(value);" style="min-width:170px; height:calc(100% - 220px); ">
	</select>
</div> 
<div class="right_side" > 
	<div class="top_side">
		<div style="float:left; width:140px;">
			<input id="descrsql" style="float:left; width:140px;" />
			<button style="  width:120px; height:20px;"  onclick="runsql();" >run</button>
			<input id="autorun" type="checkbox" style=" float:right; " title="autorun" />
			<button style="  width:150px; height:20px;"  onclick="savesql();" >save</button>
			<input id="key" style="  width:150px; height:20px;"   ></input>
		</div>
		<div style="position:relative; border:solid; left: 0px;   width:calc(100% - 177px - 155px); height:130px; background-color: red; ">
			<textarea id="txtsql" onkeypress="if(window.event.keyCode==13 && !window.event.shiftKey){runsql();return false;}" style="resize:none;  border:solid; width:calc(100% - 0px);  height:127px;" spellcheck="false"></textarea>
		</div>
	</div>
	<div id="wrapper">
	</div>
</div>

<script> 
  document.getElementById("key").addEventListener("keydown", function(event) {
    if (event.key === "Enter") {
      checklogin(this.value);
    }
  });
addtables();
addsqlt();
</script>
</body>
</html>






